<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>私の猫ちゃんたち</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      /* ★★★★★★★★★★★★★★★★★★★★★★★★★★★★ */
      /* ★ チャットUI用にCSSを大幅に変更 ★ */
      /* ★★★★★★★★★★★★★★★★★★★★★★★★★★★★ */
      html, body {
        margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans CJK JP", "Yu Gothic", sans-serif; color: #333; overflow: hidden;
      }
      .main-container { display: flex; height: 100vh; }
      .cats-area { flex: 0 0 60%; overflow-y: auto; padding: 24px; box-sizing: border-box; }
      .resizer { flex: 0 0 10px; background-color: #f1f1f1; cursor: col-resize; border-left: 1px solid #ddd; border-right: 1px solid #ddd; }
      .resizer:hover { background-color: #007bff; }
      /* QAセクションをチャットUIコンテナに */
      #chat-container { 
        flex: 1 1 auto; 
        display: flex; 
        flex-direction: column; 
        background-color: #e5ddd5; /* 背景色を変更 */
        height: 100%; 
        min-width: 300px;
      }
      /* メッセージ表示エリア */
      #message-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      /* メッセージの吹き出し共通スタイル */
      .message {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 18px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      /* AIからのメッセージ（左側） */
      .ai-message {
        background-color: #fff;
        align-self: flex-start;
        border-top-left-radius: 4px;
      }
      /* ユーザーからのメッセージ（右側） */
      .user-message {
        background-color: #dcf8c6;
        align-self: flex-end;
        border-top-right-radius: 4px;
      }
      /* 入力フォームエリア */
      #input-area {
        padding: 10px;
        background-color: #f0f0f0;
        border-top: 1px solid #ddd;
      }
      #suggestion-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }
      .suggestion-btn {
        padding: 6px 10px;
        font-size: 13px;
        background-color: #fff;
        color: #007bff;
        border: 1px solid #007bff;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .suggestion-btn:hover { background-color: #f0f8ff; }
      /* 質問入力と送信ボタンのコンテナ */
      #question-form {
        display: flex;
        gap: 10px;
      }
      #question-input { 
        flex-grow: 1;
        padding: 10px; 
        font-size: 16px; 
        border: 1px solid #ccc; 
        border-radius: 20px; 
      }
      #ask-button { 
        padding: 10px 20px; 
        font-size: 16px; 
        font-weight: bold; 
        color: white; 
        background-color: #007bff; 
        border: none; 
        border-radius: 20px; 
        cursor: pointer;
      }
      #ask-button:disabled { background-color: #ccc; cursor: not-allowed; }

      .cat-container { margin-bottom: 25px; }
      .cat-container h3 { margin-bottom: 5px; }
      .cat-container img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
      @media (max-width: 768px) {
        html, body { overflow: auto; } .main-container { flex-direction: column; height: auto; } .resizer { display: none; }
        #chat-container { min-width: unset; border-top: 2px solid #ddd; }
      }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="cats-area">
            <h1>こんにちは、私の可愛い猫ちゃんたち！</h1>
            <div class="cat-container"><h3>１：ぴの</h3><img src="images/pino.jpg" alt="猫の「ぴの」"></div>
            <div class="cat-container"><h3>２：てと</h3><img src="images/teto.jpg" alt="猫の「てと」"></div>
            <div class="cat-container"><h3>３：るか</h3><img src="images/ruka.jpg" alt="猫の「るか」"></div>
            <div class="cat-container"><h3>４：あび</h3><img src="images/abi.jpg" alt="猫の「あび」"></div>
            <div class="cat-container"><h3>５：べる</h3><img src="images/bell.JPG" alt="猫の「べる」"></div>
            <div class="cat-container"><h3>６：らて</h3><img src="images/rate.JPG" alt="猫の「らて」"></div>
        </div>
        <div class="resizer" id="drag-handle"></div>
        <!-- ★★★ qa-section を chat-container に変更 ★★★ -->
        <div id="chat-container">
            <div id="message-area">
                <div class="message ai-message">にゃん！ぼくは猫のAIだよ！<br>誰のことでも、なんでも聞いてね！</div>
            </div>
            <div id="input-area">
                <div id="suggestion-buttons">
                  <button class="suggestion-btn">全員紹介して</button>
                  <button class="suggestion-btn">ぴののこと教えて</button>
                  <button class="suggestion-btn">一番の甘えん坊は誰？</button>
                </div>
                <div id="question-form">
                    <input type="text" id="question-input" placeholder="メッセージを入力...">
                    <button id="ask-button">送信</button>
                </div>
            </div>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const questionInput = document.getElementById('question-input');
        const askButton = document.getElementById('ask-button');
        const messageArea = document.getElementById('message-area');
        const suggestionButtonsContainer = document.getElementById('suggestion-buttons');
        
        // ★★★ 会話履歴を保持する配列 ★★★
        let chatHistory = [];

        // ★★★ メッセージを画面に追加するヘルパー関数 ★★★
        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            messageElement.textContent = text;
            messageArea.appendChild(messageElement);
            // スクロールを一番下に移動
            messageArea.scrollTop = messageArea.scrollHeight;
            return messageElement;
        }

        async function askAI(userQuestion) {
          if (!userQuestion) return;

          // 1. ユーザーの質問を画面に追加
          addMessage(userQuestion, 'user');
          chatHistory.push({role: "user", parts: [{text: userQuestion}]});

          askButton.disabled = true;
          questionInput.value = ''; // 入力欄をクリア

          // 2. AIの返信用の吹き出しを作成
          const aiMessageElement = addMessage('考え中...', 'ai');

          try {
            const response = await fetch('/ask', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              // ★★★ 会話履歴と新しい質問をサーバーに送る ★★★
              body: JSON.stringify({ 
                  history: chatHistory.slice(0, -1), // 今回の質問は除く
                  question: userQuestion 
              }),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || 'サーバーでエラーが発生しました。');
            }
            
            let isFirstChunk = true;
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let aiResponseText = '';
            
            while (true) {
              const { value, done } = await reader.read();
              if (done) {
                // 3. AIの返信が完了したら、履歴に追加
                chatHistory.push({role: "model", parts: [{text: aiResponseText}]});
                break;
              }
              
              if(isFirstChunk) {
                aiMessageElement.textContent = '';
                isFirstChunk = false;
              }
              const chunkText = decoder.decode(value, { stream: true });
              aiResponseText += chunkText;
              aiMessageElement.textContent = aiResponseText; // 吹き出しの中身を更新
              messageArea.scrollTop = messageArea.scrollHeight; // スクロール
            }
          } catch (error) {
            console.error('通信エラー:', error);
            aiMessageElement.textContent = 'エラーが発生しました: ' + error.message;
          } finally {
            askButton.disabled = false;
          }
        }

        // 送信ボタンのクリックイベント
        askButton.addEventListener('click', () => askAI(questionInput.value));

        // サジェストボタンのクリックイベント
        suggestionButtonsContainer.addEventListener('click', function(event) {
          if (event.target.classList.contains('suggestion-btn')) {
            askAI(event.target.textContent);
          }
        });

        // Enterキーでの送信
        questionInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                askAI(questionInput.value);
            }
        });

        const resizer = document.getElementById('drag-handle');
        const leftSide = document.querySelector('.cats-area');
        
        resizer.addEventListener('mousedown', function(e) {
          let x = e.clientX;
          let leftWidth = leftSide.getBoundingClientRect().width;
          const mouseMoveHandler = function(e) {
            const dx = e.clientX - x;
            const newLeftWidth = leftWidth + dx;
            leftSide.style.flexBasis = `${newLeftWidth}px`;
          };
          const mouseUpHandler = function() {
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
          };
          document.addEventListener('mousemove', mouseMoveHandler);
          document.addEventListener('mouseup', mouseUpHandler);
        });
      });
    </script>

</body>
</html>