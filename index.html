<!-- HTMLの他の部分は変更なし -->

<script>
  const questionInput = document.getElementById('question-input');
  const askButton = document.getElementById('ask-button');
  const answerArea = document.getElementById('answer-area');

  askButton.addEventListener('click', async function() {
    const userQuestion = questionInput.value;
    if (!userQuestion) {
      answerArea.textContent = '質問を入力してください。';
      return;
    }

    askButton.disabled = true;
    answerArea.textContent = ''; // ★【変更点】まず答えのエリアを空にする
    
    try {
      const response = await fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: userQuestion }),
      });

      if (!response.ok) {
        // ★【変更点】エラーハンドリングを先に行う
        const errorData = await response.json();
        throw new Error(errorData.error || 'サーバーでエラーが発生しました。');
      }

      // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
      // ★ ここからが、ストリーミングを受信するための変更点です ★
      // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

      const reader = response.body.getReader(); // レスポンスを読み取るためのリーダーを取得
      const decoder = new TextDecoder(); // バイトデータを文字に変換するためのデコーダー
      
      // ストリームが続く限り、データを読み取り続けるループ
      while (true) {
        const { value, done } = await reader.read(); // データの断片（chunk）を読み取る
        if (done) {
          // doneがtrueならストリームの終わり
          break;
        }
        // 読み取ったバイトデータを文字列に変換
        const chunkText = decoder.decode(value);
        // 答えのエリアに、受け取ったテキストを追記していく
        answerArea.textContent += chunkText;
      }
      
      // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
      // ★ 変更はここまでです ★
      // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

    } catch (error) {
      console.error('通信エラー:', error);
      answerArea.textContent = 'エラーが発生しました: ' + error.message;
    } finally {
      askButton.disabled = false;
    }
  });

  // リサイズ機能のためのJavaScriptは変更なし
  const resizer = document.getElementById('drag-handle');
  const leftSide = document.querySelector('.cats-area');
  // ...（以下のリサイズ部分は元のコードのまま）
  resizer.addEventListener('mousedown', function(e) {
    let x = e.clientX;
    let leftWidth = leftSide.getBoundingClientRect().width;
    const mouseMoveHandler = function(e) {
      const dx = e.clientX - x;
      const newLeftWidth = leftWidth + dx;
      leftSide.style.width = `${newLeftWidth}px`;
    };
    const mouseUpHandler = function() {
      document.removeEventListener('mousemove', mouseMoveHandler);
      document.removeEventListener('mouseup', mouseUpHandler);
    };
    document.addEventListener('mousemove', mouseMoveHandler);
    document.addEventListener('mouseup', mouseUpHandler);
  });
</script>
